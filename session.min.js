/**
 * session.js 0.0.2
 * (c) 2012 Iain, CodeJoust
 * session is freely distributable under the MIT license.
 * Portions of session.js are inspired or borrowed from Underscore.js, and quirksmode.org demo javascript.
 * This version uses google's jsapi library for location services.
 * For details, see: https://github.com/codejoust/session.js
 */(function(a,b){var c={use_html5_location:!1,ipinfodb_key:null,gapi_location:!0,session_days:32,location_cookie_name:"location",session_cookie_name:"first_session",location_cookie_hours:2};if("session_opts"in a)for(opt in a.session_opts)c[opt]=a.session_opts[opt];var d={detect_browser:function(){return{browser:this.searchString(this.dataBrowser),version:this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion),OS:this.searchString(this.dataOS)}},searchString:function(a){for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;this.versionSearchString=a[b].versionSearch||a[b].identity;if(c){if(c.indexOf(a[b].subString)!=-1)return a[b].identity}else if(d)return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(b!=-1)return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:a.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.userAgent,subString:"iPad",identitiy:"iPad"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]},e={stringify_json:JSON.stringify||function(a){var b=typeof a;if(b!="object"||a===null){b=="string"&&(a='"'+a+'"');return String(a)}var c,d,e=[],f=a&&a.constructor==Array;for(c in a)d=a[c],b=typeof d,b=="string"?d='"'+d+'"':b=="object"&&d!==null&&(d=JSON.stringify(d)),e.push((f?"":'"'+c+'":')+String(d));return(f?"[":"{")+String(e)+(f?"]":"}")},parse_json:JSON.parse||function(a){return typeof a!="string"||!a?null:(new Function("return "+a))()},set_cookie:function(a,b,c){var d=new Date;d.setDate(d.getDate()+c),document.cookie=a+"="+escape(b)+(c==null?"":";expires="+d.toGMTString())},get_cookie:function(a){if(document.cookie.length>0){c_start=document.cookie.indexOf(a+"=");if(c_start!=-1){c_start=c_start+a.length+1,c_end=document.cookie.indexOf(";",c_start),c_end==-1&&(c_end=document.cookie.length);return unescape(document.cookie.substring(c_start,c_end))}}return null},each:function(a,b,c){if(a!=null)if(a.length===+a.length){for(var d=0,e=a.length;d<e;d++)if(d in a&&b.call(c,a[d],d,a)==={})return}else for(var f in a)if(hasOwnProperty.call(a,f)&&b.call(c,a[f],f,a)==={})return},any:function(a,b,c){b||(b=_.identity);var d=!1;if(a==null)return d;e.each(a,function(a,e,f){if(d||(d=b.call(c,a,e,f)))return{}});return!!d},search:function(a,b,c){var d;e.any(a,function(a,e,f){d=b.call(c,a,e,f);if(d)return!0});return d},find:function(a,b,c){var d;e.any(a,function(a,e,f){if(b.call(c,a,e,f)){d=a;return!0}});return d},is_undef:function(a){return a===void 0},embed_script:function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.getElementsByTagName("head")[0].appendChild(b)}},f={locale:function(){var a=e.search(["language","browserLanguage","systemLanguage","userLanguage"],function(a){return navigator[a]}),b=a.split("-");return b.length==2?{country:b[1],lang:b[0]}:{lang:a}},browser:function(){return d.detect_browser()},device:function(){var c={screen:{width:screen.width,height:screen.height},viewport:{}},d=b.documentElement,e=b.getElementsByTagName("body")[0],f=navigator.userAgent;c.viewport.width=a.innerWidth||d.clientWidth||e.clientWidth,c.viewport.height=a.innerHeight||d.clientHeight||e.clientHeight,c.is_tablet=!!f.match(/(iPad|SCH-I800|xoom|kindle)/i),c.is_phone=!c.is_tablet&&!!f.match(/(iPhone|iPod|blackberry|android 0.5|htc|lg|midp|mmp|mobile|nokia|opera mini|palm|pocket|psp|sgh|smartphone|symbian|treo mini|Playstation Portable|SonyEricsson|Samsung|MobileExplorer|PalmSource|Benq|Windows Phone|Windows Mobile|IEMobile|Windows CE|Nintendo Wii)/i),c.is_mobile=c.is_tablet||c.is_phone;return c},plugins:function(){var a=function(a){if(navigator.plugins)return!!e.find(navigator.plugins,function(b){if(b&&b.name&&b.name.toLowerCase().indexOf(a)!==-1)return!0})};return{flash:a("flash"),silverlight:a("silverlight"),java:a("java"),quicktime:a("quicktime")}},session:function(c,d){if(c)var f=e.get_cookie(c);if(!f){f={visits:1,search:{engine:null,query:null}};var g=[{nm:"Google",url:"https?://(?:www.)?(?:images.)?google.(?:com|[a-z]{2}|com?.[a-z]{2})",query:"q"},{nm:"Bing",url:"https?://(?:www.)?bing.com",query:"q"},{nm:"Yahoo",url:"https?://(?:www.)?(?:.+.)?search.yahoo.(?:com|[a-z]{2}|com?.[a-z]{2})",query:"p"},{nm:"AOL",url:"https?://(?:www.)?(?:aol)?search.aol.(?:com|[a-z]{2}|com?.[a-z]{2})",query:"q"},{nm:"Ask",url:"https?://(?:www.)?(?:[a-z]+.)?ask.com",query:"q"},{nm:"Baidu",url:"https?://(?:www.)?baidu.com",query:"wd"}];e.find(g,function(a){var c=RegExp(a.url+"/.*[?&]"+a.query+"=([^&]+)").exec(b.referrer);if(c){f.search.engine=a.nm,f.search.query=a.query;return!0}}),f.search.engine||e.find(["q","query","term","p","wd","query","text"],function(a){var c=RegExp("[?&]"+a+"=([^&]+)").exec(b.referrer);if(c){f.search.engine="Unknown",f.search.query=c;return!0}}),f.referrer=b.referrer,f.url=a.location.href,f.path=a.location.pathname,f.start=(new Date).getTime(),f.last_visit=f.start,c&&e.set_cookie(c,JSON.stringify(f),d)}else f=JSON.parse(f),f.last_visit=(new Date).getTime(),f.visits+=1,e.set_cookie(c,JSON.stringify(f),d);return f},html5_location:function(){return function(a){navigator.geolocation.getCurrentPosition(function(a){a.source="html5";return a},function(b){c.gapi_location?f.gapi_location()(a):a({err:!0,source:"html5"})})}},gapi_location:function(){return function(b){var d=null;e.get_cookie(c.location_cookie_name)?b(e.parse_json(e.get_cookie(c.location_cookie_name))):(a.gloader_loaded=function(){"google"in window&&(a.google.loader.ClientLocation?(a.google.loader.ClientLocation.source="google",b(a.google.loader.ClientLocation)):b({err:!0,source:"google"}),e.set_cookie(c.location_cookie_name,e.stringify_json(a.google.loader.ClientLocation),36e5*c.location_cookie_hours))},e.embed_script("https://www.google.com/jsapi?callback=gloader_loaded"))}},ipinfodb_location:function(b){return function(d){var g=e.get_cookie(c.location_cookie_name);if(g)return d(JSON.parse(g));a.ipinfocb=function(a){if(a.statusCode=="OK")a.source="ipinfodb",e.set_cookie(c.location_cookie_name,JSON.stringify(a),36e5*c.location_cookie_hours),d(a);else{if(c.gapi_location)return f.gapi()(d);d({err:!0,source:"ipinfodb"})}},e.embed_script("http://api.ipinfodb.com/v3/ip-city/?key="+b+"&format=json&callback=ipinfocb")}}},g={modules:{locale:f.locale(),cur_session:f.session(),orig_session:f.session(c.session_cookie_name,864e5*c.session_days),browser:f.browser(),plugins:f.plugins(),device:f.device()},init:function(){c.use_html5_location?g.modules.location=f.html5_location():c.ipinfodb_key?g.modules.location=f.ipinfodb_location(c.ipinfodb_key):c.gapi_location&&(g.modules.location=f.gapi_location());var b=0,d=function(){b==0&&a.session_loaded&&a.session_loaded(a.session)};a.modules=g.modules,a.session={api_version:.2};for(module_name in g.modules)(function(c){var e=g.modules[c];if(typeof e=="function")try{var f=e;typeof f=="function"?(b++,f(function(e){a.session[c]=e,b--,d()})):a.session[c]=f}catch(h){typeof console!="undefined"&&console.log(h)}else a.session[c]=e})(module_name);d()}};g.init()})(window,document)